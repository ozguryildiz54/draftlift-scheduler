
"use strict";const $=(id)=>document.getElementById(id);const $$=(s)=>Array.from(document.querySelectorAll(s));
function applyTheme(){const pref=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light';const t=localStorage.getItem('theme')||pref;document.documentElement.classList.toggle('dark',t==='dark');}
applyTheme();$('btnTheme').onclick=()=>{const t=document.documentElement.classList.contains('dark')?'light':'dark';localStorage.setItem('theme',t);applyTheme();};
function applyVariant(){const v=localStorage.getItem('uiVariant')||'classic';document.body.setAttribute('data-ui',v);const bar=$('classicBar');if(bar)bar.style.display=v==='classic'?'flex':'none';}
applyVariant();window.addEventListener('keydown',(e)=>{if(e.key==='F1'){e.preventDefault();window.open('/help.html','_blank');}if(e.ctrlKey&&e.key.toLowerCase()==='b'){const cur=localStorage.getItem('uiVariant')||'classic';localStorage.setItem('uiVariant',cur==='classic'?'tabbed':'classic');applyVariant();render();}});
function activateTab(n){$$('.tabpanel').forEach(p=>p.classList.toggle('active',p.id==='tab-'+n));$$('.tab').forEach(t=>t.setAttribute('aria-selected',t.dataset.tab===n?'true':'false'));localStorage.setItem('tab',n);}
$$('.tab').forEach(t=>t.onclick=()=>activateTab(t.dataset.tab));activateTab(localStorage.getItem('tab')||'plan');
document.body.addEventListener('click',(e)=>{const tip=e.target.closest('.tip');$$('.tip.open').forEach(x=>{if(x!==tip)x.classList.remove('open');});if(tip)tip.classList.toggle('open');});
document.body.addEventListener('mouseover',(e)=>{const tip=e.target.closest('.tip');if(tip)tip.classList.add('open');});
document.body.addEventListener('mouseout',(e)=>{const tip=e.target.closest('.tip');if(tip)tip.classList.remove('open');});
let items=[];let role='admin';let tzOffset=0;let dirty=false;let autosnapMin=0;
function pad(n){return n<10?'0'+n:''+n}function utcToZoneISO(iso,off){if(!iso)return'';const d=new Date(iso);if(isNaN(d.getTime()))return'';const t=d.getTime()+off*60000;const z=new Date(t);return z.getFullYear()+'-'+pad(z.getMonth()+1)+'-'+pad(z.getDate())+'T'+pad(z.getHours())+':'+pad(z.getMinutes());}
function zoneToUTC(local,off){if(!local)return'';const m=local.match(/(\d+)/g);const Y=parseInt(m[0]),M=parseInt(m[1]),D=parseInt(m[2]),h=parseInt(m[3]),mi=parseInt(m[4]);const t=Date.UTC(Y,M-1,D,h,mi)-off*60000;return new Date(t).toISOString().replace('.000','');}
(function(){const s=$('tzSelect');if(!s)return;for(let o=-720;o<=840;o+=60){const opt=document.createElement('option');opt.value=o;opt.textContent=(o>=0?'+':'')+(o/60);s.appendChild(opt);}fetch('/api/config').then(r=>r.json()).then(j=>{if(j.ok){role=j.data?.ROLE||'admin';tzOffset=j.data?.DEFAULT_TZ||0;autosnapMin=j.data?.AUTOSNAPSHOT_MIN||0;s.value=tzOffset;render();}});s.onchange=()=>{tzOffset=parseInt(s.value,10)||0;render();};})();
async function api(url,opts={}){const r=await fetch(url,Object.assign({headers:{'Content-Type':'application/json'}},opts));const j=await r.json().catch(()=>({ok:false,error:'json'}));if(!j.ok)throw new Error(j.error||'hata');return j;}
async function runAction(id,fn){const b=$(id);if(b){if(b._busy)return;b._busy=true;const o=b.textContent;b.textContent='⋯';b.disabled=true;try{return await fn();}finally{b._busy=false;b.textContent=o;b.disabled=false;}}else{return await fn();}}
async function load(){const j=await api('/api/schedule');items=j.data||[];}
async function save(){const e=validateAll();if(e.length){alert('Hata: '+e.join(', '));return;}await api('/api/schedule',{method:'POST',body:JSON.stringify({data:items})});dirty=false;}
async function commit(){await save();await api('/api/commit',{method:'POST'});alert('Push tamam.');}
async function refreshSnaps(){const j=await api('/api/snapshots');$('snaps').textContent=j.data.join('\n')||'yok';}
async function refreshHistory(){try{const j=await api('/api/history');$('history').textContent=j.data.map(x=>JSON.stringify(x)).join('\n')||'kayıt yok';}catch(_){}}
function findConflicts(){const arr=items.slice().sort((a,b)=>String(a.livePath).localeCompare(String(b.livePath))||String(a.publish_at).localeCompare(String(b.publish_at)));const out=[];for(let i=1;i<arr.length;i++){if(!arr[i-1].publish_at||!arr[i].publish_at)continue;if(arr[i-1].livePath!==arr[i].livePath)continue;const d1=new Date(arr[i-1].publish_at).getTime(),d2=new Date(arr[i].publish_at).getTime();if(Math.abs(d2-d1)<15*60*1000)out.push([arr[i-1],arr[i]]);}return out;}
function autoFixConflicts(){const c=findConflicts();c.forEach(([a,b])=>{const t=new Date(a.publish_at).getTime()+16*60*1000;b.publish_at=new Date(t).toISOString().replace('.000','');});render();}
function smartPlan(){const by={};items.forEach(it=>{by[it.livePath]=by[it.livePath]||[];by[it.livePath].push(it);});for(const k of Object.keys(by)){const arr=by[k].sort((a,b)=>(a.publish_at||'').localeCompare(b.publish_at||''));let t=Date.now();arr.forEach((it)=>{t+=20*60*1000;it.publish_at=new Date(t).toISOString().replace('.000','');});}render();}
function shiftDeps(){const map=new Map(items.map(x=>[x.name,x]));items.forEach(it=>{const deps=String(it.depends_on||'').split(',').map(s=>s.trim()).filter(Boolean);deps.forEach(dn=>{const dep=map.get(dn);if(!dep||!dep.publish_at)return;const t=new Date(dep.publish_at).getTime()+15*60*1000;if(!it.publish_at||new Date(it.publish_at).getTime()<t)it.publish_at=new Date(t).toISOString().replace('.000','');});});render();}
function validateAll(){const errs=[];const names=new Set();items.forEach((it,i)=>{if(!it.name)errs.push(`satır ${i+1}: name`);if(names.has(it.name))errs.push(`satır ${i+1}: uniq name`);else names.add(it.name);if(!/^drafts\//.test(it.draftPath||''))errs.push(`satır ${i+1}: draftPath`);if(!/^projects\//.test(it.livePath||''))errs.push(`satır ${i+1}: livePath`);if(!it.publish_at||isNaN(new Date(it.publish_at).getTime()))errs.push(`satır ${i+1}: date`);});if(findConflicts().length)errs.push('conflict<15m');const unapproved=items.filter(x=>(x.env||'')==='prod'&&!x.approved);if(unapproved.length)errs.push('prod approval missing');return errs;}
function setFieldError(td,msg){let e=td.querySelector('.err');if(msg){td.classList.add('bad');if(!e){e=document.createElement('div');e.className='err';td.appendChild(e);}e.textContent=msg;}else{td.classList.remove('bad');if(e)e.remove();}}
function validateRow(i,td,field){let m='';const it=items[i];if(field==='name'){if(!it.name)m='Bu alan zorunlu.';const cnt=items.reduce((a,x)=>{a[x.name]=(a[x.name]||0)+1;return a;},{});if(it.name&&cnt[it.name]>1)m='İsim benzersiz olmalı.';}if(field==='draftPath'){if(!/^drafts\//.test(it.draftPath||''))m='Yol drafts/ ile başlamalı.';}if(field==='livePath'){if(!/^projects\//.test(it.livePath||''))m='Yol projects/ ile başlamalı.';}if(field==='publish_at'){if(!it.publish_at||isNaN(new Date(it.publish_at).getTime()))m='Geçerli tarih gir.';}setFieldError(td,m);}
function render(){const tzOff=parseInt(($('tzSelect')?.value||tzOffset),10)||0;const wrap=$('table');const t=document.createElement('table');t.innerHTML=`<thead><tr><th>#</th><th>Seç</th><th>Ad <span class="tip"><span class="info">ℹ</span><span class="tip-bubble">Kısa ve benzersiz bir isim gir.</span></span></th><th>Taslak <span class="tip"><span class="info">ℹ</span><span class="tip-bubble">Yerel çalışma klasörün. drafts/... ile başlamalı.</span></span></th><th>Canlı <span class="tip"><span class="info">ℹ</span><span class="tip-bubble">Yayınlanacağı yol. projects/... ile başlamalı.</span></span></th><th>Yerel Zaman <span class="tip"><span class="info">ℹ</span><span class="tip-bubble">Seçtiğin saat diliminde giriş; UTC otomatik hesaplanır.</span></span></th><th>UTC <span class="tip"><span class="info">ℹ</span><span class="tip-bubble">Sunucuya gidecek kesin tarih/saat.</span></span></th><th>Tag</th><th>Env</th><th>Bağımlılık</th><th>Onay</th><th>Aksiyonlar</th></tr></thead><tbody></tbody>`;const tb=t.querySelector('tbody');items.forEach((it,idx)=>{const tr=document.createElement('tr');const td0=document.createElement('td');td0.textContent=String(idx+1);tr.appendChild(td0);const tdSel=document.createElement('td');const c=document.createElement('input');c.type='checkbox';c.checked=!!it._sel;c.onchange=e=>{items[idx]._sel=e.target.checked;};tdSel.appendChild(c);tr.appendChild(tdSel);const tdName=document.createElement('td');const inName=document.createElement('input');inName.value=it.name||'';inName.oninput=e=>{items[idx].name=e.target.value;dirty=true;validateRow(idx,tdName,'name');};tdName.appendChild(inName);tr.appendChild(tdName);const tdDraft=document.createElement('td');const inDraft=document.createElement('input');inDraft.value=it.draftPath||'';inDraft.placeholder='drafts/...';inDraft.oninput=e=>{items[idx].draftPath=e.target.value;dirty=true;validateRow(idx,tdDraft,'draftPath');};tdDraft.appendChild(inDraft);tr.appendChild(tdDraft);const tdLive=document.createElement('td');const inLive=document.createElement('input');inLive.value=it.livePath||'';inLive.placeholder='projects/...';inLive.oninput=e=>{items[idx].livePath=e.target.value;dirty=true;validateRow(idx,tdLive,'livePath');};tdLive.appendChild(inLive);tr.appendChild(tdLive);const tdLocal=document.createElement('td');const inLocal=document.createElement('input');inLocal.type='datetime-local';inLocal.value=utcToZoneISO(it.publish_at,tzOff)||'';inLocal.oninput=e2=>{const iso=zoneToUTC(e2.target.value,tzOff);items[idx].publish_at=iso;dirty=true;validateRow(idx,tdLocal,'publish_at');inUTC.value=iso;};tdLocal.appendChild(inLocal);tr.appendChild(tdLocal);const tdUTC=document.createElement('td');const inUTC=document.createElement('input');inUTC.readOnly=true;inUTC.value=it.publish_at||'';tdUTC.appendChild(inUTC);tr.appendChild(tdUTC);const tdTag=document.createElement('td');const inTag=document.createElement('input');inTag.value=it.tag||'';inTag.oninput=e=>{items[idx].tag=e.target.value;dirty=true;};tdTag.appendChild(inTag);tr.appendChild(tdTag);const tdEnv=document.createElement('td');const sel=document.createElement('select');['','stage','prod'].forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v||'env';sel.appendChild(o);});sel.value=it.env||'';sel.onchange=e=>{items[idx].env=e.target.value;dirty=true;};tdEnv.appendChild(sel);tr.appendChild(tdEnv);const tdDep=document.createElement('td');const inDep=document.createElement('input');inDep.placeholder='A,B';inDep.value=it.depends_on||'';inDep.oninput=e=>{items[idx].depends_on=e.target.value;dirty=true;};tdDep.appendChild(inDep);tr.appendChild(tdDep);const tdAp=document.createElement('td');const chk=document.createElement('input');chk.type='checkbox';chk.checked=!!it.approved;chk.onchange=e=>{items[idx].approved=e.target.checked;dirty=true;};tdAp.appendChild(chk);tr.appendChild(tdAp);const tdAct=document.createElement('td');const bNow=document.createElement('button');bNow.className='small ghost';bNow.textContent='Şimdi';bNow.onclick=()=>{items[idx].publish_at=new Date().toISOString().replace('.000','');dirty=true;render();};const bDel=document.createElement('button');bDel.className='small ghost';bDel.textContent='Sil';bDel.onclick=()=>{const ask=prompt(`Silmek için 'SIL ${it.name||''}' yaz`,'');if(ask===`SIL ${it.name||''}`){items.splice(idx,1);render();}};tdAct.appendChild(bNow);tdAct.appendChild(bDel);tr.appendChild(tdAct);validateRow(idx,tdName,'name');validateRow(idx,tdDraft,'draftPath');validateRow(idx,tdLive,'livePath');validateRow(idx,tdLocal,'publish_at');tb.appendChild(tr);});wrap.innerHTML='';wrap.appendChild(t);}
$('btnAdd').onclick=()=>{items.push({name:'',draftPath:'drafts/',livePath:'projects/',publish_at:new Date().toISOString().replace('.000',''),env:'stage',tag:''});render();};
$('fixConflicts').onclick=autoFixConflicts;$('smartPlan').onclick=smartPlan;$('shiftDeps').onclick=shiftDeps;$('btnWeek').onclick=()=>alert('Haftalık görünüm: özet panel (geliştirilebilir).');
$('btnSave').onclick=()=>runAction('btnSave',()=>save());$('btnDryRun').onclick=()=>alert(validateAll().join('\n')||'OK');$('btnRunNow').onclick=()=>alert('Simülasyon: Yayınlandı (demo).');$('btnCommit').onclick=()=>runAction('btnCommit',commit);$('webhookTest').onclick=()=>runAction('webhookTest',()=>api('/api/webhook/test',{method:'POST'}).then(()=>alert('Test gönderildi')));$('histRefresh').onclick=refreshHistory;
document.addEventListener('DOMContentLoaded',()=>{if($('cBtnAdd'))$('cBtnAdd').onclick=()=>$('btnAdd')?.click();if($('cBtnSave'))$('cBtnSave').onclick=()=>$('btnSave')?.click();if($('cBtnCommit'))$('cBtnCommit').onclick=()=>$('btnCommit')?.click();if($('cBtnRefresh'))$('cBtnRefresh').onclick=()=>{load().then(render);};});
$('btnPick').onclick=()=>$('folderPick').click();$('btnUpload').onclick=()=>runAction('btnUpload',async()=>{const name=($('draftName').value||'').trim();if(!name){alert('Proje adı gerekli');return;}const files=$('folderPick').files;if(!files||files.length===0){alert('Lütfen klasör seçin');return;}const fd=new FormData();fd.append('project',name);for(const f of files){fd.append('files',f,f.webkitRelativePath||f.name);}const r=await fetch('/api/upload',{method:'POST',body:fd});const j=await r.json();if(!j.ok)throw new Error(j.error||'upload failed');alert('Yüklendi');});
$('btnExportJSON').onclick=()=>{const a=document.createElement('a');const blob=new Blob([JSON.stringify(items,null,2)],{type:'application/json'});a.href=URL.createObjectURL(blob);a.download='schedule.json';a.click();};
$('btnSnapshot').onclick=()=>runAction('btnSnapshot',()=>api('/api/snapshot',{method:'POST'}).then(()=>refreshSnaps()));$('btnSnapReload').onclick=refreshSnaps;
async function init(){try{const j=await fetch('/api/config').then(r=>r.json()).catch(()=>({ok:false}));if(j.ok){role=j.data?.ROLE||'admin';tzOffset=j.data?.DEFAULT_TZ||0;}}catch(_){}await load();render();refreshHistory();refreshSnaps();}
init();
